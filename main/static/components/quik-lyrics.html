<head>
    <link rel="import" href="/static/components/paper-autocomplete/paper-autocomplete.html">
    <link rel="import" href="/static/bower_components/paper-card/paper-card.html">
    <link rel="import" href="/static/bower_components/iron-ajax/iron-ajax.html" />
    <link rel="import" href="/static/bower_components/iron-list/iron-list.html" />
    <link rel="import" href="/static/bower_components/paper-collapse-item/paper-collapse-item.html" />
    <link rel="import" href="/static/bower_components/pushstate-anchor/pushstate-anchor.html">
    <link rel="import" href="/static/bower_components/app-route/app-route.html">
    <link rel="import" href="/static/bower_components/app-route/app-location.html">
    <link rel="import" href="/static/bower_components/paper-item/paper-item.html">    
    <link rel="import" href="/static/bower_components/app-layout/app-toolbar/app-toolbar.html">
    <link rel="import" href="/static/bower_components/app-layout/app-header/app-header.html">
    <link rel="import" href="/static/bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
    <link rel="import" href="/static/bower_components/app-layout/app-header-layout/app-header-layout.html">
    <link rel="import" href="/static/bower_components/paper-progress/paper-progress.html" />
    <link rel="import" href="/static/bower_components/paper-radio-group/paper-radio-group.html" />
    <link rel="import" href="/static/bower_components/paper-styles/color.html" />
    <link rel="import" href="/static/bower_components/paper-styles/paper-styles-classes.html" />
    <link rel="import" href="/static/bower_components/paper-styles/typography.html" />
    <link rel="import" href="/static/bower_components/paper-radio-button/paper-radio-button.html" />
    <link rel="import" href="/static/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
    <link rel="import" href="/static/bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="/static/bower_components/paper-styles/default-theme.html" />
    <link rel="import" href="html-echo.html">
    <link rel="import" href="/static/css/style.html" />
    <style>
	.quik-lyrics.content {
  		margin: 2%;
	}
	.recent-result .search-term {
		width: 80%;
		white-space: nowrap; 
	    overflow: hidden; 
	    text-overflow: ellipsis;
	    display: inline-block;
	}
	paper-icon-item.recent {
		width: 100%;
	}
</style>
</head>
<dom-module id="quik-lyrics">
  <template>
  <iron-iconset-svg name="recent" size="24">
  <svg>
    <defs>
      <g id="pick">
        <svg style="width:24px;height:24px" viewBox="0 0 24 24">
    		<path fill="#000000" d="M19,4.1C18.1,3.3 17,2.8 15.8,2.5C15.5,2.4 13.6,2 12.2,2C12.2,2 12.1,2 12,2C12,2 11.9,2 11.8,2C10.4,2 8.4,2.4 8.1,2.5C7,2.8 5.9,3.3 5,4.1C3,5.9 3,8.7 4,11C5,13.5 6.1,15.7 7.6,17.9C8.8,19.6 10.1,22 12,22C13.9,22 15.2,19.6 16.5,17.9C18,15.8 19.1,13.5 20.1,11C21,8.7 21,5.9 19,4.1M18.2,10.2C17.1,12.9 16.1,14.9 14.8,16.7C14.6,16.9 14.5,17.2 14.3,17.4C13.8,18.2 12.6,20 12,20C12,20 12,20 12,20C11.3,20 10.2,18.3 9.6,17.4C9.4,17.2 9.3,16.9 9.1,16.7C7.9,14.9 6.8,12.9 5.7,10.2C5.5,9.5 4.7,7 6.3,5.5C6.8,5 7.6,4.7 8.6,4.4C9,4.4 10.7,4 11.8,4C11.8,4 12.1,4 12.1,4C13.2,4 14.9,4.3 15.3,4.4C16.3,4.7 17.1,5 17.6,5.5C19.3,7 18.5,9.5 18.2,10.2Z" />
		</svg>
      </g>
      <g id="mic">
      <svg style="width:24px;height:24px" viewBox="0 0 24 24">
	    <path fill="#000000" d="M9,3A4,4 0 0,1 13,7H5A4,4 0 0,1 9,3M11.84,9.82L11,18H10V19A2,2 0 0,0 12,21A2,2 0 0,0 14,19V14A4,4 0 0,1 18,10H20L19,11L20,12H18A2,2 0 0,0 16,14V19A4,4 0 0,1 12,23A4,4 0 0,1 8,19V18H7L6.16,9.82C5.67,9.32 5.31,8.7 5.13,8H12.87C12.69,8.7 12.33,9.32 11.84,9.82M9,11A1,1 0 0,0 8,12A1,1 0 0,0 9,13A1,1 0 0,0 10,12A1,1 0 0,0 9,11Z" />
	  </svg>
      </g>
    </defs>
  </svg>
</iron-iconset-svg>
  <app-location route="{{route}}" use-hash-as-path></app-location>
  <app-route
      route="{{route}}"
      active="{{active}}"
      pattern="/:lyricsOrChords/:lyrics"
      data="{{routeData}}"
      tail="{{routeDataTail}}">
  </app-route>
    <iron-ajax
      auto
      url="/suggest"
      params="[[_updateParams(suggestQuery)]]"
      handle-as="json"
      last-response="{{suggestions}}">
    ></iron-ajax>
    <iron-ajax
      auto
      loading="{{loading}}"
      id="lyrics-ajax"
      url="/[[routeData.lyricsOrChords]]"
      params="[[_updateParams(routeData.lyrics)]]"
      handle-as="json"
      on-error="_handleErrorResponse"
      last-response="{{lyrics}}"></iron-ajax>
    <iron-ajax
      auto
      id="alternatives-ajax"
      verbose="true"
      loading="{{urlLoading}}"
      url="/url"
      params="[[_alternativeParams(selectedAlternative)]]"
      last-response="{{lyrics.Lyrics}}"
      on-error="_handleErrorResponse"
      handle-as="json"></iron-ajax>
    <iron-ajax
      id="recent-ajax"
      auto
      verbose="true"
      loading="{{recentLoading}}"
      url="/recent"
      last-response="{{recent}}"
      on-error="_handleErrorResponse"
      handle-as="json"></iron-ajax>
      <app-header-layout>
        <app-header reveals effects="waterfall">
          <app-toolbar>
            <a class="nostyle" href="/quik#/lyrics/you stick around and it may show">
              <div title>QuikLyrics</div>
            </a>
            <paper-radio-group selected="{{routeData.lyricsOrChords}}">
              <paper-radio-button name="lyrics" class="light-indigo">Lyrics</paper-radio-button>
              <paper-radio-button name="chords" class="light-indigo">Chords</paper-radio-button>
            </paper-radio-group>
          </app-toolbar>
          <paper-autocomplete id="paperauto" class="flex" autofocus="autofocus" label="[[autocompleteLabel]]" min-length="2" source="[[_processSuggestions(suggestions)]]" text="{{suggestQuery}}" on-autocomplete-selected="_updateLyricsQuery"></paper-autocomplete>
        </app-header>
    <template is="dom-if" if="[[!_progressDisabled(loading, urlLoading, recentLoading)]]">
    <paper-progress class="pink" indeterminate disabled="[[_progressDisabled(loading, urlLoading, recentLoading)]]"></paper-progress>
    </template>
    <paper-collapse-item opened="{{openedCollapse}}" header="Other Results" icon="icons:list">
    <iron-list as="item" items="[[lyrics.Alternatives]]" selection-enabled selected-item="{{selectedAlternative}}">
      <template>
        <paper-item>
        <div>[[item.Title]]</div>
        </paper-item>
      </template>
    </iron-list>
    </paper-collapse-item>
    <paper-collapse-item opened="{{openedCollapseRecent}}" header="Recent Searches" icon="icons:watch-later">
    <iron-list as="item" items="[[recent]]" selection-enabled selected-item="{{selectedRecent}}">
      <template>
      	<paper-item>
        <paper-icon-item class="recent">
        <div class="recent-result">
	        <iron-icon icon="[[_recentIcon(item.LyricsOrChords)]]" item-icon></iron-icon>
	        <div class="search-term">[[item.SearchTerm]]</div>
	        <div secondary>([[item.FormattedDate]])</div>
        </div>
        </paper-icon-item>
        </paper-item>
      </template>
    </iron-list>
    </paper-collapse-item>
    <div class="quiklyrics content">
    <paper-card heading="[[lyrics.Lyrics.Title]]">
    <div class="card-content">
    <template is="dom-if" if="[[!loading]]">
    <div id="actual-lyrics">
    <template is="dom-if" if="[[_isLyrics(routeData.lyricsOrChords, loading)]]">
      [[lyrics.Lyrics.Lyrics]]
    </template>
    <template is="dom-if" if="[[_isChords(routeData.lyricsOrChords, loading)]]">
      <tt>
        <html-echo html="[[lyrics.Lyrics.Lyrics]]"></html-echo>
      </tt>
    </template>
    </div>
    </div>
    </template>
    </paper-card>
    </div>
    </app-header-layout>
    <style is="custom-style">
  paper-radio-button.light-indigo {
    --paper-radio-button-checked-color: var(--paper-indigo-400);
    --paper-radio-button-checked-ink-color: var(--paper-indigo-400);
    --paper-radio-button-unchecked-color: var(--paper-indigo-600);
    --paper-radio-button-unchecked-ink-color: var(--paper-indigo-600);
    --paper-radio-button-label-color: var(--paper-indigo-100);
  }
  paper-progress.pink {
    --paper-progress-active-color: var(--paper-pink-700);
    --paper-progress-secondary-color: var(--paper-indigo-300);
    width:100%;
    display: block;
  }
  app-header {
        background: var(--paper-indigo-900);
        color: var(--paper-indigo-100);
}

app-header-layout {
  background: var(--paper-indigo-025);
}

paper-autocomplete {
  margin-left: 3%;
  margin-right: 3%;  
}


paper-input-container.paper-input-container-0 {
  padding-top: 0px;
}
</style>
<style is="custom-style">
:root {
        --paper-input-container-input-color: var(--paper-indigo-100);
}
</style>
  </template>
  <script>
  Polymer({
    is: 'quik-lyrics',
    properties: {
      "lyrics": Object,
      "selectedRecent": {
      	type: Object,
      	observer: "_selectedRecent",
      },
      "autocompleteLabel": {
        type: String,
        value: "Lyrics or song sample"
      }

    },
    observers: [
      '_updateRouteDataLyrics(routeData.lyrics)',
    ],
    attached: function() {
        if (this.route.path === '') {
          this.set('route.path', '/lyrics/');
        }
        if (this.routeData.lyrics.length != 0) {
          this.suggestQuery = this.routeData.lyrics;
        }
    },
    _isChords: function(lyricsOrChords, loading) {
      return 'chords' == lyricsOrChords && !loading;
    },
    _isLyrics: function(lyricsOrChords, loading) {
      return 'lyrics' == lyricsOrChords && !loading;
    },
    _updateParams: function(s) {
    	this.openedCollapse = false;
    	this.openedCollapseRecent = false;
      this.$['recent-ajax'].generateRequest();
      return {lyrics: s, lyricsOrChords: this.routeData.lyricsOrChords};
    },
    _processSuggestions: function(s) {
      return s.suggestions.map(function(ss){
        return {value: ss , text: ss};
      });
    },
    _updateLyricsQuery: function(event) {
      var lyricsSearch = event.detail.text;
      this.set('routeData.lyrics', lyricsSearch);
    },
    _recentIcon: function(lyricsOrChords) {
    	if (lyricsOrChords == 'lyrics') {
    		return "recent:mic";
    	} else {
    		return "recent:pick";
    	}
    },
    _alternativeParams: function(item) {
      this.openedCollapse = false;
      this.openedCollapseRecent = false;
      if (item == null) {
        var oldParams = this.$['alternatives-ajax'].params;
        if (oldParams == undefined) {
          return {};
        }
        return oldParams;
      }
      this.suggestQuery = item.Title;
      return {
        url: item.Url,
        lyricsOrChords: this.routeData.lyricsOrChords
      };
    },
    _handleErrorResponse: function() {
    	this.set('lyrics', {Lyrics: {
    		Lyrics: "No results. Try adding the artist, or something else...",
    		Title: ""
    	}, Alternatives: []});
    },
    _selectedRecent: function(item) {
    	this.openedCollapseRecent = false;
    	if (item == null) {
    		return;
    	}
      this.suggestQuery = item.SearchTerm;
    	this.set('routeData.lyricsOrChords', item.LyricsOrChords);
    	this.set('routeData.lyrics', item.SearchTerm);
    },
    _progressDisabled: function(loading, urlLoading, recentLoading) {
      console.log(loading + ", " + urlLoading + ", " + recentLoading);
      return !this.loading && !this.urlLoading && !this.recentLoading;
    },
    _updateRouteDataLyrics: function(l) {
      var useAuto = l.length > 0;
      this.$['alternatives-ajax'].auto = useAuto;
      this.$['lyrics-ajax'].auto = useAuto;      
      this.autocompleteLabel = useAuto ? "Song or lyrics sample" : "Search a song name or lyrics, like 'girl close your eyes'";
      if (l != this.suggestQuery) {
        this.suggestQuery = l;
      }
    },
  });
  </script>
  </dom-module>